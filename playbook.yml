---
- hosts: all
  user: sdey
  become: true

  vars:
    user: sdey

  tasks:
    - name: Update packages
      apt:
       update_cache: yes
    
    - name: Install list of packages
      apt: name={{item}} state=installed
      with_items:
       - git
       - vim
       - wget
       - tree
       - build-essential
       - zsh
       - tig
       
    - name:  Ensure sdey user exists
      user: 
       name: '{{user}}'
       password: $6$QCmNVoH2xHr0.WoA$JALsrpqN.XvuazAh7Mv10eIAZb7CvL6w/LiOAxZpiumlKHpdeY6JRWP6aKlKmHV//c.AOrlm0hsoBthZhf1Ui1
       shell: /bin/zsh
       createhome: yes
       state: present 
       comment: Subhranil Dey

    - name: Ensure sdey user is sudoer with no password required
      lineinfile:
       dest: /etc/sudoers
       state: present
       regexp: '^{{user}} ALL\='
       line: '{{user}} ALL=(ALL) NOPASSWD:ALL'
       validate: 'visudo -cf %s'
      
    - name: Allow ssh password authentication for sdey
      lineinfile:
        dest: /etc/ssh/sshd_config
        state: present
        backrefs: yes
        regexp: '^PasswordAuthentication\sno$'
        line: 'PasswordAuthentication yes'

    - name: Restart sshd
      service: name=ssh state=restarted
      
    - name: Clone oh-my-zsh repo
      git: repo=https://github.com/robbyrussell/oh-my-zsh.git dest=/home/{{user}}/.oh-my-zsh

    - name: Configure zsh syntax highlighting
      git: repo=https://github.com/zsh-users/zsh-syntax-highlighting.git dest=/usr/local/share/zsh-syntax-highlighting

    - name: Deploy .zshrc
      template: src=zshrc-template.j2 dest=/home/{{user}}/.zshrc owner='{{user}}' group='{{user}}'

    - name: source bashrc file
      shell: "{{ item }}"
      with_items:
         - runuser -l  sdey -c 'source /home/{{user}}/.zshrc'
